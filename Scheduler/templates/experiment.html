{% extends 'base.html' %}
{% import '_logView.html' as logView %}

{% block scripts %}
    {{ super() }}
    {{ logView.logScripts() }}
{% endblock %}

{% macro accordionCard(accordion, card, logInfo) %}
    {% set LogLevels = ['Debug', 'Info', 'Warning', 'Error', 'Critical'] %}
    <div class="card">
    <div class="card-header" id="{{ card }}Header">
        <button class="btn btn-block" type="button" data-toggle="collapse"
                data-target="#{{ card }}Log" aria-expanded="false" aria-controls="{{ card }}Log">
          {{ card }} Log
            {% for level in LogLevels %}
                {% set count = logInfo.Count[level] %}
                {% if count != 0 %}
                    <span class="label color{{ level }}" style="background: navy">{{ count }}</span>
                {% endif %}
            {% endfor %}
        </button>
    </div>
    <div id="{{ card }}Log" class="collapse" aria-labelledby="{{ card }}Header" data-parent="#{{ accordion }}">
      <div class="card-body">
        {{ logView.logView(logInfo) }}
      </div>
    </div>
  </div>

{% endmacro %}

{% macro executorTimes(name, executor) %}
    <div class="container">
        <h3>{{ name }}</h3>
        {% if executor.Started is not none %}
            <p>
                Started: {{ moment(executor.Started).format('LLL') }} ({{ moment(executor.Started).fromNow() }}, waited
                {{ moment(executor.Started).fromTime(executor.Created, no_suffix = True) }})
            </p>
        {% else %}
            <p> Not started</p>
        {% endif %}
        {% if executor.Finished is not none %}
            <p>
                Finished: {{ moment(executor.Finished).format('LLL') }} ({{ moment(executor.Finished).fromNow() }}, ran for
                {{ moment(executor.Started).fromTime(executor.Created, no_suffix = True) }})
            </p>
        {% endif %}
    </div>
{% endmacro %}

{% block app_content %}
    <div class="container">
        Status: <span class="badge">{{ experiment.CoarseStatus.name }}</span> <span class="badge">{{ experiment.Status }}</span>
        Created: {{ moment(experiment.Created).format('LLL') }} ({{ moment(experiment.Created).fromNow() }})
    </div>

    <div class="accordion" id="logAccordion">
      {{ executorTimes('Pre-Run', experiment.PreRunner) }}
      {{ accordionCard('logAccordion', 'Pre-Run', experiment.PreRunner.RetrieveLogInfo()) }}
      {{ executorTimes('Run', experiment.Executor) }}
      {{ accordionCard('logAccordion', 'Run', experiment.Executor.RetrieveLogInfo()) }}
      {{ executorTimes('Post-Run', experiment.PostRunner) }}
      {{ accordionCard('logAccordion', 'Post-Run', experiment.PostRunner.RetrieveLogInfo()) }}
    </div>
{% endblock %}
